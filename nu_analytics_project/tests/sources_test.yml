# models/staging/_sources.yml
version: 2

sources:
  - name: nu_sources
    description: "Raw data from Nubank's transactional and dimensional tables"
    database: nu_db
    schema: nu_raw_schema
    
    # Global freshness check
    freshness:
      warn_after: {count: 6, period: hour}
      error_after: {count: 12, period: hour}
    
    tables:
      - name: pix_movements
        description: "PIX payment transactions"
        tests:
          - dbt_utils.row_count:
              above: 100  # Should have at least 100 transactions
        columns:
          - name: id
            description: "Unique identifier for PIX transaction"
            tests:
              - not_null
              - unique
          - name: account_id
            description: "Foreign key to accounts table"
            tests:
              - not_null
              - relationships:
                  to: source('nu_sources', 'accounts')
                  field: account_id
          - name: pix_amount
            description: "Transaction amount in BRL"
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  min_value: 0.01
                  max_value: 1000000
                  config:
                    severity: warn
          - name: status
            description: "Transaction status"
            tests:
              - not_null
              - accepted_values:
                  values: ['completed', 'pending', 'failed', 'cancelled']
          - name: in_or_out
            description: "Transaction direction"
            tests:
              - not_null
              - accepted_values:
                  values: ['in', 'out']

      - name: transfer_ins
        description: "Incoming transfer transactions"
        tests:
          - dbt_utils.row_count:
              above: 50
        columns:
          - name: id
            tests:
              - not_null
              - unique
          - name: account_id
            tests:
              - not_null
              - relationships:
                  to: source('nu_sources', 'accounts')
                  field: account_id
          - name: amount
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  min_value: 0.01
                  max_value: 1000000
          - name: status
            tests:
              - accepted_values:
                  values: ['completed', 'pending', 'failed', 'cancelled']

      - name: transfer_outs
        description: "Outgoing transfer transactions"
        tests:
          - dbt_utils.row_count:
              above: 50
        columns:
          - name: id
            tests:
              - not_null
              - unique
          - name: account_id
            tests:
              - not_null
          - name: amount
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  min_value: 0.01
                  max_value: 1000000

      - name: accounts
        description: "Customer account information"
        tests:
          - dbt_utils.row_count:
              above: 10  # Should have at least 10 accounts
        columns:
          - name: account_id
            description: "Unique account identifier"
            tests:
              - not_null
              - unique
          - name: status
            description: "Account status"
            tests:
              - not_null
              - accepted_values:
                  values: ['active', 'closed', 'suspended']
          - name: created_at
            tests:
              - not_null

      - name: customers
        description: "Customer master data"
        columns:
          - name: customer_id
            tests:
              - not_null
              - unique
          - name: cpf
            description: "Brazilian tax ID - contains PII"
            tags: ['pii']
            tests:
              - not_null
              - unique

      # Dimension tables
      - name: d_time
        description: "Time dimension with hierarchical attributes"
        tests:
          - dbt_utils.row_count:
              above: 365  # Should have at least 1 year of data
        columns:
          - name: time_id
            tests:
              - not_null
              - unique
          - name: action_timestamp
            tests:
              - not_null

      - name: d_week
        columns:
          - name: week_id
            tests:
              - not_null
              - unique

      - name: d_month
        columns:
          - name: month_id
            tests:
              - not_null
              - unique
          - name: action_month
            tests:
              - dbt_utils.accepted_range:
                  min_value: 1
                  max_value: 12

      - name: d_year
        columns:
          - name: year_id
            tests:
              - not_null
              - unique

      - name: d_weekday
        columns:
          - name: weekday_id
            tests:
              - not_null
              - unique

      - name: city
        description: "City dimension"
        columns:
          - name: city_id
            tests:
              - not_null
              - unique

      - name: state  
        description: "State dimension"
        columns:
          - name: state_id
            tests:
              - not_null
              - unique

      - name: country
        description: "Country dimension"
        columns:
          - name: country_id
            tests:
              - not_null
              - unique